
@{
    var fieldsets = ProduceFieldsets(Entity, ParentCollection);

    var table = ParentCollection?.RelationEnd.Table;

    var name = table?.PrimaryNameColumn?.Apply(nc => Entity.ColumnValues[nc.Name]);
}

@if (table != null)
{
    <header>
        <a href="@Context.RenderEntityUrl(table, Entity)">
            <span class="entity-thumb">@table.Abbreviation</span>
            @if (name != null)
            {
                <span class="entity-name">@name</span>
            }
        </a>
    </header>
}

@foreach (var fs in fieldsets)
{
    var emptyClass = fs.items.FirstOrDefault() == null ? "fieldset-empty" : null;

    <fieldset class="@emptyClass" data-name="@fs.legend" data-layout="@fs.layout">
        <legend>@fs.legend</legend>
        @foreach (var field in fs.items)
        {
            if (field is EntityColumnFieldUi c)
            {
                <EntityColumnView Entity="c.Entity" Table="c.Table" Column="c.Column" Cls="c.RenderClass" />
            }
            else if (field is EntityRelationFieldUi r)
            {
                <EntityRelationView Ui="r" />
            }
            else
            {
                <div class="alert">Unknown ui element</div>
            }
        }
    </fieldset>
}

@code {
    [Parameter]
    public Entity Entity { get; set; }

    [Parameter]
    public RelatedEntities ParentCollection { get; set; }

    [CascadingParameter]
    public QueryContext Context { get; set; }

    struct Fieldset
    {
        public String legend;
        public String layout;
        public IEnumerable<EntityFieldUi> items;
    }

    ColumnRenderClass GetRenderClass(CMTable table, CMColumn column)
    {
        if (table.PrimaryNameColumn == column) return ColumnRenderClass.PrimaryName;

        return ColumnRenderClass.Data;
    }

    Boolean IsColumnRenderedInFlavor(CMColumn column, ExtentFlavorType flavorType)
    {
        switch (flavorType)
        {
            case ExtentFlavorType.Page:
                return !column.IsPrimaryName;
            default:
                return false;
        }
    }

    IEnumerable<Fieldset> ProduceFieldsets(Entity entity, RelatedEntities parentCollection = null)
    {
        var table = parentCollection?.RelationEnd.Table;

        var flavor = parentCollection?.Extent.Flavor;

        var columns = (parentCollection?.Extent?.Columns ?? Enumerable.Empty<String>())
            .Select(cn => table.Columns[cn]).ToLookup(c => GetRenderClass(table, c));

        var orderColumns = parentCollection?.Extent?.Order?.Apply(o => new HashSet<String>(o.Select(c => c.c)));

        var columnClasses = Enum.GetValues(typeof(ColumnRenderClass)) as ColumnRenderClass[];

        var groups =
            from cl in columnClasses
            from c in columns[cl]
            where (orderColumns?.Contains(c.Name) ?? false) || IsColumnRenderedInFlavor(c, flavor?.type ?? ExtentFlavorType.Page)
            group c by cl into g
            select new Fieldset { legend = g.Key.ToString().ToLower(), layout = "grid3", items = g.Select(c => new EntityColumnFieldUi { Table = table, Entity = entity, Column = c, RenderClass = g.Key }) }
            ;

        var relations = (from r in entity.Related group r by r.RelationEnd.IsMany).ToArray();

        var singulars = relations.FirstOrDefault(r => !r.Key)?.ToArray();
        var plurals = relations.FirstOrDefault(r => r.Key)?.ToArray();

        var groupsList = groups.ToList();

        if (singulars != null)
        {
            groupsList.Add(new Fieldset { legend = "singulars", items = singulars.Select(r => new EntityRelationFieldUi { Table = table, Entity = entity, RelatedEntites = r }) });
        }

        if (plurals != null)
        {
            groupsList.Add(new Fieldset { legend = "plurals", items = plurals.Select(r => new EntityRelationFieldUi { Table = table, Entity = entity, RelatedEntites = r }) });
        }

        return groupsList;
    }
}
